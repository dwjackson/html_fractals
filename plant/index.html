<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Fractal Plant</title>
    <style>
      #myCanvas {
	border: 1px solid black;
      }
      h1 { 
	font-family: 'Helvetica', Helvetica, Sans;
      }
    </style>
    <script>
      function FractalPlant(iters) {
	this.variables = ['X', 'F'];
	this.axiom = 'X';
	this.angle = 0.125663706;
	this.rules = {'X': 'F-[[X]+X]+F[+FX]-X',
		      'F': 'FF',
		      '+': '+',
		      '-': '-',
		      '[': '[',
		      ']': ']'};

	var str = this.axiom;
	var new_str;
	var c;
        for (var i = 0; i < iters; i++) {
	  new_str = "";
	  for (var j = 0; j < str.length; j++) {
	    c = str[j];
	    new_str += this.rules[c];
	  }
	  str = new_str;
	}
	this.str = str;
      }
      function draw_plant(start_x, start_y, str, context) {
	var pos = {'x': start_x, 'y': start_y};
	var vec = {'x': 0.5, 'y': -0.5};
	var stack = [];
	var u = 10; // Unit length in pixels

	var R = [[0.906, -0.423], [0.423, 0.906]];
	var Rp = [[0.906, 0.423], [-0.423, 0.906]];

	context.moveTo(pos['x'], pos['y']);
	context.strokeStyle = '#006600';

	var c;
	var tmp = {'x': 0.0, 'y': 0.0};
	for (var i = 0; i < str.length; i++) {
	  c = str[i];
	  if (c == 'F') {
	    console.log('pos = ' + JSON.stringify(pos));
	    context.moveTo(pos['x'], pos['y']);

	    pos['x'] = pos['x'] + u * vec['x'];
	    pos['y'] = pos['y'] + u * vec['y'];

	    context.lineTo(pos['x'], pos['y']);
	    context.stroke();
	  } else if (c == '-') {
	    tmp['x'] = vec['x'];
	    tmp['y'] = vec['y'];
	    vec['x'] = R[0][0] * tmp['x'] + R[0][1] * tmp['y'];
	    vec['y'] = R[1][0] * tmp['x'] + R[1][1] * tmp['y'];
	  } else if (c == '+') {
	    tmp['x'] = vec['x'];
	    tmp['y'] = vec['y'];
	    vec['x'] = Rp[0][0] * tmp['x'] + Rp[0][1] * tmp['y'];
	    vec['y'] = Rp[1][0] * tmp['x'] + Rp[1][1] * tmp['y'];
	  } else if (c == '[') {
	    var tmp_pos = {'x': pos['x'], 'y': pos['y']};
	    var tmp_vec = {'x': vec['x'], 'y': vec['y']};
	    stack.push([tmp_pos, tmp_vec]);
	  } else if (c == ']') {
	    var pos_vec = stack.pop();
	    pos['x'] = pos_vec[0]['x'];
	    pos['y'] = pos_vec[0]['y'];
	    vec['x'] = pos_vec[1]['x'];
	    vec['y'] = pos_vec[1]['y'];
	  }
	}
      }
    </script>
  </head>
  <body>
    <h1>Fractal Plant</h1>
    <div id="plantstr"></div>
    <canvas id="myCanvas" height="800" width="800"></canvas>
    <script>
      var iters = 5;
      var plant = new FractalPlant(iters);

      var canvas = document.getElementById('myCanvas');
      var context = canvas.getContext('2d');

      var div = document.getElementById('plantstr');
      //div.innerHTML = '<p>' + plant.str + '</p>';

      draw_plant(10, 790, plant.str, context);
    </script>
  </body>
</html>
